<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="fragment/_layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <title>상품구매창</title>
    <style>
/* Add a margin and padding reset */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

main {
      margin: 0 auto;
      width: 500px;
}

/* Style for the table and its elements */
table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
}

table thead {
  font-weight: bold;
  background-color: #f5f5f5;
}

table td,
table th {
  padding: 10px;
  border: 1px solid #ddd;
}

/* Style for the form button */
button {
  display: block;
  margin: 20px auto;
  padding: 10px;
  border: none;
  border-radius: 5px;
  background-color: #007bff;
  color: #fff;
  cursor: pointer;
}

button:hover {
  background-color: #0069d9;
}

/* Responsive styles for mobile devices */
@media screen and (max-width: 600px) {
  main {
      margin: 0 auto;
      width: 70%;
  }
  table td,
  table th {
    font-size: 14px;
    padding: 8px;
  }
  
  table td:first-child {
    font-weight: bold;
  }
  
  table td:nth-child(even) {
    text-align: right;
  }
  
  table td:last-child {
    border-bottom: none;
  }
  
  table td:last-child:before {
    content: attr(data-label);
    float: left;
    font-weight: bold;
    text-transform: uppercase;
  }
  
  button {
    width: 100%;
    margin: 10px auto;
  }
}
    </style>
    <script>
      function payment(){
            var IMP = window.IMP; 
			IMP.init("imp07716558"); 
		    IMP.request_pay({
		        pg : 'html5_inicis.INIpayTest',
		        pay_method : 'card',
		        merchant_uid: 'merchant_'+new Date().getTime(), 
		        name : '시터예약',
		        amount : '100', //${book.res_pay},테스트용으로 100원 고정
		        buyer_email : '<%=user.getUser_email()%>',
		        buyer_name : '<%=user.getUser_name()%>',
		        buyer_tel : '<%=user.getUser_phone()%>',
		        buyer_addr : '<%=user.getUser_addr()%>',
		        buyer_postcode : <%=user.getUser_no() %>
		    }, function (rsp) { // callback
		    	
		    	//결제성공시
		        if (rsp.success) {
		        	
		        	//백단에 내용전달
					$.ajax({
						url : 'ajax/payment.do',
						type : 'POST',
			            //dataType: 'json',
			            contentType: 'application/json; charset=utf-8',
						data : JSON.stringify(rsp),
						success : function(result) {
							console.log(result);
							
							//백단에 성공적으로 들어갔을시
							//실패시 자동환불(백단에서)
							let process_result = result.process_result.split(":");
 							if(process_result[0]=='결제성공'){
								alert('결제성공!');
								
								//성공시 완료페이지로 이동
								let alink = '/requestBook.do?sit_no='+${sitter.sit_no }+'&merchant_uid='+process_result[1]+"";
								console.log(alink);
								window.location.href = alink;
							}else{
								alert(process_result[1]);
							}

						},error: function(result){
							alert(result);
						}
					});
		        } else {
		            alert("결제실패!");
		        }
		    });
      }

    </script>
</head>
<body>
<div layout:fragment="content">
      <main>
            <section>
                  <form action="buyProduct" method="po">
                        <article>
                              <table>
                                    <thead>상품</thead>
                                    <tr><td>상품</td><td th:text="${product.product_name}"></td></tr>
                                    <tr><td>수량</td><td th:text="${product.amount}">1</td></tr>
                                    <tr><td colspan="2">
                                          <table>
                                                <thead>금액상세</thead>
                                                <tr><td>금액</td><td th:text="${product.price*product.amount}">+15000원</td></tr>
                                                <tr><td th:text="${'할인율(' + product.discount_rate+'%)'}">할인율(5%)</td><td th:text="${(product.price*product.amount*product.discount_rate)+'원'}">-750원</td></tr>
                                                <tr><td>배송비</td><td th:text="${delivery_price+'원'}">+3000원</td></tr>
                                                <tr><td>총금액</td><td th:text="${(product.price*product.amount*(1-product.discount_rate))+delivery_price}">17000원</td></tr>
                                          </table>
                                    </td></tr>
                                    <tr><td>배송지주소</td><td>서울시 노원구 xxx xxx</td></tr>
                                    <tr><td>카드 </td><td><select name="" id="">
                                          <option th:each="card : ${cards}" th:text="${card.type + ' ' + #strings.mask(card.card_no, '*', 4, 8)}" th:value="${card.card_id}">카드번호 xxx</option>
                                    </select></td></tr>
                                    <tr><td colspan="2"><button onclick="payment()">결제하기</button></td></tr>
                              </table>

                        </article>

                  </form>
            </section>
      </main>
</div>
</body>
</html>